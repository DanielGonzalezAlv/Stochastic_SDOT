\documentclass[
     12pt,         % font size
     a4paper,      % paper format
     BCOR=10mm,     % binding correction
     DIV=14,        % stripe size for margin calculation
%     liststotoc,   % table listing in toc
%     bibtotoc,     % bibliography in toc
%     idxtotoc,     % index in toc
%     parskip       % paragraph skip instad of paragraph indent
     ]{scrreprt}

\input{../preamble.tex}

% Avoid Problems by including other files
\usepackage{standalone}

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\begin{document}
%
%   \begin{large}
%       \noindent \textbf{Notations and Nomenclature} \\
%       \vspace{1cm}
%   \end{large}
%
%
%\TODO{NOTES}
%    We recall some definitions and results from measure theory. 
%    \bigskip

%Image = 256 x 256 x 3 \\
%Over iterations nscales$=4-1 : -1 : 0$
%\begin{enumerate}
%    \item scale image ($2^{iter}$ ) i.e in first iter=3 : $256 / 2^3 =32$
%    \item then generate on with 2 dim more, (i.e scale im with  $256 / 2^2 = 64 $)
%\end{enumerate}
%\begin{itemize}
%    \item In first iteration, i.e iter = 3: estime adsn model on scaled image (32x32x3)
%\end{itemize}


\noindent \Large\textbf{Multi-layer approach}  \\[12pt] \normalsize
%
%\TODO{NOTES}
%
\noindent \large\textbf{Target measure decomposition}  \\[8pt] \normalsize
%
\unsure{IDEA}
\textit{Decompose} the target measure $\nu = \sum_{s\in S} \nu_s \delta_s$ at different scales using the K-means algorithm (Lloyd's algorithm) $\longrightarrow$ 
Generate a finite sequence of discrete probabity measures $\{\nu_l \}_{l=0, \dots, L}$ with decreasing support and such that $\nu_{l+1}$ should be a \textit{similar} 
to $\nu_{l}$. 
%
\unsure{MORE PRECISELY}
Using a clustering algorithm, generate a finite sequence of finite sets $\{ S \equal S^0, \dots, S^L\}$ (to use as support for the discrete probabilty distributions) such that $|S^l| < |S^{l+1}|$ for all $l\in\{0,\dots,L-1\} $ (and $|S^L|=1$).
Then, define $\nu^0 \coloneqq \nu$ and use successively transport maps to define the distributions on the supports $S^l$, i.e. define measurable maps 
\[\pi_l : S^l \to S^{l+1} \quad   \text{and set}\quad \nu^{l+1} \coloneqq {\pi_l}_{\#}\nu^l. \]
Thus, we get get successibly %for $l = 0, \dots, L-1 $ %
probabilty measures $\nu^{l+1} = \sum_{s\in S^{l+1}} \nu^{l+1}_s \delta_s$ supported on $S^{l+1}$ satisfying 
%
\[ \nu_s^{l+1} = \nu^{l+1}(s) = \nu^l(\pi_l^{-1}(s)) = \sum_{p \in \pi_l^{-1}(s) } \nu^l_p .\]
%
\textbf{Idea: } Using Lloyd's algorithm we get: $\pi_l:  x \mapsto \argmin_{s\in S^{l+1}} \| x - s \|^2 .$ \\[12pt]
%
\noindent \large\textbf{Multi-layer Transport Map - With 2 Layers (as in Paper)}  \\[8pt] \normalsize
%\textbf{?Main idea here?!COPYPASTE:} Use multi-scale representation of the target distribution to sequentially estimate a hierarchical Laguerre cell partitioning of the source distribution \\
\textbf{Reminder from last chapter (is written different):}
\begin{align*}
    h^\nu (x,W) : \R^d \times \R^{|S|} &\to \R, \\
    (x,W) &\mapsto \min_{s\in S} \pow_W(x,s) + \langle W, \nu \rangle =  (\min_{s\in S} \|x-s\|^2 -W(s)) + \langle W, \nu \rangle
\end{align*}
Then we have 
\[ \nabla_W h^\nu = \nu -\1_{T_W(x)=s}^{S}. \]
Where 
\[\1_{T_W(x)=s}^{S}: S \to \R, \quad     
            x \mapsto
            \begin{cases} 
                1 &\mbox{if } x=T_W(x) \\
                0 & \mbox{else } 
            \end{cases} . \]

\textbf{Sketch of the algorithm:}\\[8pt]
\underline{Given:} $\mu$ (Target distribution), $\nu$ (Source distribution), $L=2$ (number of layers). 
\begin{itemize}
    \item Decompose target measure: $\{\nu^l\}_{l=0,1}$, $\{S^l\}_{l=0,1}$ as above.
%    \item Set $\omega^l = \nu^l$,  for $l=0,1$.
    \item Set $W^l = 0$,  for $l=0,1$. (Weights to be computed)
    \item Set $n^l: S^l \to 0 $,  for $l=0,1$. (Number of visits of points in $S^l$)
\end{itemize}
\underline{Apply ASGD.}  At each iteration: sample $x \sim \mu$ and then:
\begin{enumerate}
    \item (L=1: first layer) Compute
        \[\tilde s = \argmin_{s \in S^{1}} \| x - s \|^2 - W^1(s) .\]
        I.o.w. compute $T_{W^1}(x)$. If $W^1=0$ (as in the first iterations), this is equivalent to computing a Least-squares. 
    \item Compute gradient 
        \[g = \nabla_{W^1} h^{\nu^1} = \nu^1 - \1_{s=\tilde s}^{S^1} \]
        Where \[\1_{s=\tilde s}^{S^1}: S^1 \to \R, \quad     
            x \mapsto
            \begin{cases} 
                1 &\mbox{if } x=\tilde s \\
                0 & \mbox{else } 
            \end{cases} . \]
    \item Update $W^1$ as in Algorithm 1: 
        \[W^1 \longleftarrow \text{Use gradient, gradient-step, iteration } (g, C, iter) \]
    \item Update number of visits 
        \[n^1(\tilde s) = n^1(\tilde s) + 1 \]
    \item (L=0: second layer) Compute
        \[\tilde {\tilde{s}} = \argmin_{s \in \pi_0^{-1}(\tilde s)} \| x - s \|^2 - W^0(s) \]
        I.o.w. compute $T_{W^0|_{\pi_0^{-1}(\tilde s)}}|^{\pi_0^{-1}(\tilde s)}(x) = T_{W^0}|^{\pi_0^{-1}(\tilde s)}(x)$, 
        where $T_{W^0}|^{\pi_0^{-1}(\tilde s)}$ denotes the map $T_{W^0}$ 
        with restricted codomain ${\pi_0^{-1}(\tilde s)}$. \\ 
        Observations: 
        \begin{itemize}
            \item This computations are faster than computing
                \[T_{W^0}(x) = \argmin_{s \in S^0} \| x - s \|^2 - W^0(s), \]
                as $|\pi_0^{-1}(\tilde s)| < |S^0|$.
            \item It may happend (yes? when?) that
                \[T_{W^0}(x) \in S^0 \setminus \pi_0^{-1}(\tilde s). \]
                Consequences?
        \end{itemize}
    \item Compute gradient 
        \[\tilde g = \nabla_{W^0|_{\pi^{-1}(\tilde s)}} h^{\nu^0|_{\pi^{-1}(\tilde s)}} = \nu^0|_{\pi^{-1}(\tilde s)} - \1_{s=\tilde{\tilde{s}}}^{\pi^{-1}(\tilde s)} \]
        Where \[\1_{s=\tilde{\tilde{s}}}^{\pi^{-1}(\tilde s)}: \pi^{-1}(\tilde s) \to \R, \quad     
            x \mapsto
            \begin{cases} 
                1 &\mbox{if } x=\tilde{\tilde{s}} \\
                0 & \mbox{else } 
            \end{cases}  \]
    \item Update $W^0$ as in Algorithm 2: 
        \[W^0 \longleftarrow \text{Use gradient, gradient-step, number of visits} (\tilde g, C, n^1)  \]
        Actually, only update entries on $\pi^{-1}(\tilde s)$, i.e 
        \[ W^0|_{\pi^{-1}(s)} \longleftarrow \text{Use gradient, gradient-step, number of visits} (\tilde g, C, n^1)  \]
\end{enumerate}
%        \begin{enumerate}
%            \item[(i)] 
%                Compute 
%        \end{enumerate}


\end{document}
